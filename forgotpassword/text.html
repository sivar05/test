<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Password Reset</title>
    <style>
        /* Your CSS styles here */
        body { font-family: Arial, sans-serif; max-width: 400px; margin: 50px auto; padding: 20px; }
        .container { border: 1px solid #ddd; padding: 20px; border-radius: 5px; margin-bottom: 20px; }
        h1, h2 { text-align: center; color: #333; }
        .input-box { width: 100%; padding: 10px; margin: 10px 0; border: 1px solid #ddd; border-radius: 4px; box-sizing: border-box; }
        button { width: 100%; padding: 12px; background-color: #4CAF50; color: white; border: none; border-radius: 4px; cursor: pointer; font-size: 16px; margin-top: 10px; }
        button:hover { background-color: #45a049; }
        button:disabled { background-color: #cccccc; cursor: not-allowed; }
        #message { text-align: center; margin-top: 15px; min-height: 20px; }
        .hidden { display: none !important; }
        .step { transition: all 0.3s ease; }
    </style>
</head>
<body>
    <!-- Step 1: Email Input -->
    <div id="step1" class="step container">
        <h2>Forgot Password</h2>
        <p>Enter your email to receive a password reset link</p>
        
        <input type="email" id="email" placeholder="Enter your email" class="input-box">
        
        <button id="sendLinkBtn" disabled>
            Send Reset Link
        </button>
        
        <p id="messageStep1" class="message"></p>
    </div>
    
    <!-- Step 2: Password Reset (Initially Hidden) -->
    <div id="step2" class="step container hidden">
        <h1>Reset Password</h1>
        <p>Enter your new password</p>
        
        <input type="password" id="newPassword" placeholder="New Password" class="input-box">
        <input type="password" id="confirmPassword" placeholder="Confirm Password" class="input-box">
        
        <button id="resetBtn" class="resetBtn" disabled>
            Reset Password
        </button>
        
        <p id="messageStep2" class="message"></p>
    </div>

    <script>
        // Store email globally
        let userEmail = '';
        
        // Wait for DOM to load
        document.addEventListener('DOMContentLoaded', function() {
            // Get elements
            const emailInput = document.getElementById('email');
            const sendBtn = document.getElementById('sendLinkBtn');
            const newPasswordInput = document.getElementById('newPassword');
            const confirmPasswordInput = document.getElementById('confirmPassword');
            const resetBtn = document.getElementById('resetBtn');
            
            // Add event listeners
            emailInput.addEventListener('input', handleEmailInput);
            sendBtn.addEventListener('click', sendResetLink);
            newPasswordInput.addEventListener('input', validatePasswords);
            confirmPasswordInput.addEventListener('input', validatePasswords);
            resetBtn.addEventListener('click', resetPassword);
        });
        
        function handleEmailInput() {
            const emailInput = document.getElementById('email');
            const sendBtn = document.getElementById('sendLinkBtn');
            const email = emailInput.value.trim();
            
            // Basic email validation
            const isValidEmail = /^[^\s@]+@[^\s@]+\.[^\s@]+$/.test(email);
            
            if (email && isValidEmail) {
                sendBtn.disabled = false;
                sendBtn.textContent = "Send Reset Link";
            } else {
                sendBtn.disabled = true;
            }
        }
        
        function sendResetLink() {
            const emailInput = document.getElementById('email');
            const messageElement = document.getElementById('messageStep1');
            const sendBtn = document.getElementById('sendLinkBtn');
            
            userEmail = emailInput.value.trim();
            
            // Disable button and show loading
            sendBtn.disabled = true;
            sendBtn.textContent = "Sending...";
            messageElement.style.color = "blue";
            messageElement.textContent = "Sending reset link...";
            
            // Make API call to your backend
            fetch('/api/forgot-password', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({ email: userEmail })
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    messageElement.style.color = "green";
                    messageElement.textContent = data.message || "Reset link sent! Check your email.";
                    
                    // Switch to step 2 after 2 seconds
                    setTimeout(() => {
                        showPasswordResetStep();
                    }, 2000);
                } else {
                    messageElement.style.color = "red";
                    messageElement.textContent = data.error || "Failed to send reset link";
                    sendBtn.disabled = false;
                    sendBtn.textContent = "Send Reset Link";
                }
            })
            .catch(error => {
                console.error('Error:', error);
                messageElement.style.color = "red";
                messageElement.textContent = "Network error. Please try again.";
                sendBtn.disabled = false;
                sendBtn.textContent = "Send Reset Link";
            });
        }
        
        function showPasswordResetStep() {
            // Hide step 1
            document.getElementById('step1').classList.add('hidden');
            
            // Show step 2
            document.getElementById('step2').classList.remove('hidden');
            
            // Pre-fill email info
            const step2Title = document.querySelector('#step2 p');
            step2Title.textContent = `Enter new password for ${userEmail}`;
            
            // Focus on first password field
            document.getElementById('newPassword').focus();
        }
        
        function validatePasswords() {
            const newPassword = document.getElementById('newPassword').value;
            const confirmPassword = document.getElementById('confirmPassword').value;
            const resetBtn = document.getElementById('resetBtn');
            const messageElement = document.getElementById('messageStep2');
            
            // Clear previous messages
            messageElement.textContent = '';
            
            // Enable button only if both fields are filled and passwords match
            if (newPassword && confirmPassword) {
                if (newPassword === confirmPassword) {
                    resetBtn.disabled = false;
                    resetBtn.textContent = "Reset Password";
                } else {
                    resetBtn.disabled = true;
                    messageElement.style.color = "red";
                    messageElement.textContent = "Passwords do not match!";
                }
            } else {
                resetBtn.disabled = true;
            }
            
            // Password strength validation
            if (newPassword.length > 0 && newPassword.length < 8) {
                messageElement.style.color = "orange";
                messageElement.textContent = "Password should be at least 8 characters";
            }
        }
        
        function resetPassword() {
            const newPassword = document.getElementById('newPassword').value;
            const confirmPassword = document.getElementById('confirmPassword').value;
            const resetBtn = document.getElementById('resetBtn');
            const messageElement = document.getElementById('messageStep2');
            
            // Validation
            if (newPassword !== confirmPassword) {
                messageElement.style.color = "red";
                messageElement.textContent = "Passwords do not match!";
                return;
            }
            
            if (newPassword.length < 8) {
                messageElement.style.color = "red";
                messageElement.textContent = "Password must be at least 8 characters!";
                return;
            }
            
            // Disable button and show loading
            resetBtn.disabled = true;
            resetBtn.textContent = "Processing...";
            messageElement.style.color = "blue";
            messageElement.textContent = "Updating password...";
            
            // Make API call to your backend
            fetch('/api/resetpassword', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({ 
                    email: userEmail, 
                    password: newPassword
                    // Add token if needed: token: getTokenFromURL()
                })
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    messageElement.style.color = "green";
                    messageElement.textContent = data.message || "Password updated successfully!";
                    
                    // Show success alert and redirect
                    setTimeout(() => {
                        alert("Password updated successfully! Redirecting to login page...");
                        window.location.href = "/login"; // Change to your login page
                    }, 1500);
                } else {
                    messageElement.style.color = "red";
                    messageElement.textContent = data.error || "Failed to update password";
                    resetBtn.disabled = false;
                    resetBtn.textContent = "Reset Password";
                }
            })
            .catch(error => {
                console.error('Error:', error);
                messageElement.style.color = "red";
                messageElement.textContent = "Network error. Please try again.";
                resetBtn.disabled = false;
                resetBtn.textContent = "Reset Password";
            });
        }
        
        // Optional: Get token from URL if present
        function getTokenFromURL() {
            const urlParams = new URLSearchParams(window.location.search);
            return urlParams.get('token');
        }
        
        // Check for token in URL on page load
        window.onload = function() {
            const token = getTokenFromURL();
            if (token) {
                // Skip to step 2 if token is present
                document.getElementById('step1').classList.add('hidden');
                document.getElementById('step2').classList.remove('hidden');
                document.querySelector('#step2 p').textContent = "Enter your new password";
            }
        };
    </script>
</body>
</html>